<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mt.mms.estimate.mapper.EstimateMapper">

    <select id="selectEstimates" resultType="org.mt.mms.estimate.vo.EstimateExVO">
        SELECT /* org.mt.mms.estimate.mapper.EstimateMapper.selectEstimates : ESTIMATE 목록조회 */
            E.ESTIMATE_ID
             , E.TOP_CONTR_ID
             , E.COMP_ID
             , E.ORDER_NO
             , E.CONFIRM_YN
             , E.CONTR_YN
             , E.REGIST_DATE
             , E.REGIST_USER_NAME

             , TC.TOP_CONTR_NM
             , C.COMP_NM
        FROM ESTIMATE E
            INNER JOIN TOP_CONTR TC ON TC.TOP_CONTR_ID = E.TOP_CONTR_ID
            INNER JOIN COMP C ON C.COMP_ID = E.COMP_ID
        WHERE E.DEL_YN = 'N'
        ORDER BY E.REGIST_DATE DESC
    </select>

    <select id="selectEstimate" resultType="org.mt.mms.estimate.vo.EstimateExVO" parameterType="string">
        SELECT /* org.mt.mms.estimate.mapper.EstimateMapper.selectEstimate : ESTIMATE 상세조회 */
            ESTIMATE_ID
             , TOP_CONTR_ID
             , COMP_ID
             , ORDER_NO
             , ESTIMATE_DIV
             , CONFIRM_YN
             , CONTR_YN
             , ESTIMATE_FILE_ID
             , REGIST_DATE
             , DEL_YN
             , REGIST_USER_NAME
        FROM ESTIMATE
        WHERE ESTIMATE_ID = #{id}
            AND DEL_YN = 'N'
    </select>

    <insert id="insertEstimate" parameterType="org.mt.mms.estimate.vo.EstimateVO">
        INSERT INTO ESTIMATE /* org.mt.mms.estimate.mapper.EstimateMapper.insertEstimate : ESTIMATE 등록 */
        (
         ESTIMATE_ID
        , TOP_CONTR_ID
        , COMP_ID
        , ORDER_NO
        , ESTIMATE_DIV
        , CONFIRM_YN
        , CONTR_YN
        , ESTIMATE_FILE_ID
        , REGIST_USER_NAME
        )
        VALUES
        (
          #{estimateId}
        , #{topContrId}
        , #{compId}
        , (SELECT IFNULL(MAX(ORDER_NO), 0)+1
           FROM ESTIMATE ALIAS_FOR_SUBQUERY
           WHERE TOP_CONTR_ID=#{topContrId} AND COMP_ID=#{compId} AND ESTIMATE_DIV = #{estimateDiv}
        )
        , #{estimateDiv}
        , 'N'
        , 'N'
        , #{estimateFileId}
        , #{registUserName}
        )
    </insert>

    <select id="selectPossibleConfirm" parameterType="hashmap" resultType="int">
        SELECT COUNT(*) /* org.mt.mms.estimate.mapper.EstimateMapper.selectPossibleConfirm : ESTIMATE 확정여부 조회 */
        FROM ESTIMATE
        WHERE DEL_YN = 'N'
          AND TOP_CONTR_ID = #{topContrId}
          AND COMP_ID = #{compId}
          AND ESTIMATE_DIV = #{estimateDiv}
          AND CONFIRM_YN = 'Y'
    </select>

    <update id="updateConfirmEstimate" parameterType="string">
        UPDATE ESTIMATE SET /* org.mt.mms.estimate.mapper.EstimateMapper.updateConfirmEstimate : ESTIMATE 확정 */
            CONFIRM_YN = 'Y'
        WHERE ESTIMATE_ID = #{id}
    </update>

</mapper>
